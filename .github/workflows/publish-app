name: Build and Publish Docker image to GCP

on:
  push:
    branches: [ "main" ]

env:
  ARTIFACT_REGISTRY: images
  IMAGE_NAME: movies-application
  OWNER: sep6-bestmovies
  GCP_PROJECT_ID: movies-docker-next-js
  GCP_APP_NAME: Movie Application

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Login to GCP
      uses: google-github-actions/auth@v1
      with:
        project_id: ${{ GCP_PROJECT_ID }}
        service_account: ${{ secrets.GCP_EMAIL }}
        credentials_json: ${{ secrets.GCP_CREDENTIALS }}
        
    - name: Setup GCP environment
      uses: google-github-actions/setup-gcloud@v1
      
    - name: Configure Docker
      run: gcloud auth configure-docker --quiet
      
    - name: Login to Github Registry
      uses: docker/login-action@v2
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ env.OWNER }}
        password: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and Push Docker Image
      run: |
        docker build -t ${{ ARTIFACT_REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}:latest .
        docker push ${{ ARTIFACT_REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }}
    - name: Deploy Image
      run: gcloud run deploy ${{ GCP_PROJECT_ID }} --image ${{ ARTIFACT_REGISTRY }}/${{ env.OWNER }}/${{ env.IMAGE_NAME }} --region europe-north1 --platform managed
